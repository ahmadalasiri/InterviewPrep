# Health Checks Configuration
# Monitors backend server health

# Passive Health Checks (Open Source Nginx)
upstream backend {
    # Server marked as down after max_fails failures
    server 192.168.1.10:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.11:8080 max_fails=3 fail_timeout=30s;
    server 192.168.1.12:8080 max_fails=3 fail_timeout=30s;
    
    # Backup server used when others are down
    server 192.168.1.13:8080 backup;
}

server {
    listen 80;
    server_name example.com;
    
    location / {
        proxy_pass http://backend;
        
        # Retry on failure
        proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        
        proxy_set_header Host $host;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# Active Health Checks (Nginx Plus)
# upstream backend {
#     zone backend 64k;
#     server 192.168.1.10:8080;
#     server 192.168.1.11:8080;
# }
# 
# match server_ok {
#     status 200;
#     header Content-Type ~ "text/html";
# }
# 
# server {
#     location / {
#         proxy_pass http://backend;
#         health_check match=server_ok interval=5s fails=1 passes=1;
#     }
# }

