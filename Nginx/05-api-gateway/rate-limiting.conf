# Rate Limiting Configuration
# Controls request rates to protect backend services

# General API rate limit
limit_req_zone $binary_remote_addr zone=general:10m rate=100r/s;

# Strict limit for auth endpoints
limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;

# Connection limit
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

upstream backend {
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name api.example.com;
    
    # Auth endpoints - strict rate limit
    location /api/auth/ {
        limit_req zone=auth burst=5 nodelay;
        limit_conn conn_limit 5;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }
    
    # General API - higher rate limit
    location /api/ {
        limit_req zone=general burst=50 nodelay;
        limit_conn conn_limit 10;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }
    
    # Health check - no rate limit
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

