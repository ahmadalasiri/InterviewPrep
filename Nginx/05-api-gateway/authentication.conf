# API Authentication Configuration
# API key and basic authentication

# API key validation map
map $http_x_api_key $api_key_valid {
    default 0;
    "key123" 1;
    "key456" 1;
    "key789" 1;
}

upstream backend {
    server 127.0.0.1:8080;
}

server {
    listen 80;
    server_name api.example.com;
    
    # API key authentication
    location /api/ {
        # Check API key
        if ($api_key_valid = 0) {
            return 401 "Invalid API Key";
        }
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-API-Key $http_x_api_key;
    }
    
    # Basic authentication
    location /api/admin/ {
        auth_basic "Admin API";
        auth_basic_user_file /etc/nginx/.htpasswd;
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }
    
    # Combined: API key + IP whitelist
    location /api/secure/ {
        # IP whitelist
        allow 192.168.1.0/24;
        deny all;
        
        # API key check
        if ($api_key_valid = 0) {
            return 401 "Invalid API Key";
        }
        
        proxy_pass http://backend;
        proxy_set_header Host $host;
    }
}

# To create password file:
# sudo apt install apache2-utils
# sudo htpasswd -c /etc/nginx/.htpasswd username

